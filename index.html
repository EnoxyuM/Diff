<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="icons/favicon-64x64.png">
<title>Diff</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/bespin.min.css">

<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #0a0a0a;
        color: #00c6e0;
        font-family: monospace;
        overflow: hidden;
    }
    .container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .buttons {
        padding: 10px;
        background-color: #1a1a1a;
        border-bottom: 1px solid #00c6e0;
        flex-shrink: 0;
        display: flex;
        align-items: center;

        justify-content: space-between;
        position: relative;

    }
    .buttons button {
        background-color: #0a0a0a;
        color: #00c6e0;
        border: 1px solid #00c6e0;
        padding: 8px 12px;
        cursor: pointer;
        margin-right: 10px;
    }
    .buttons button:hover {
        background-color: #00c6e0;
        color: #0a0a0a;
    }


    #diff-nav-buttons {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: none;
    }


    #diff-nav-buttons button {
        padding: 5px 10px;
        font-size: 16px;
        line-height: 1;
        margin: 0 5px;
    }

    #diff-stats {
        font-size: 14px;
        white-space: nowrap;
    }

    .editors {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
    }
    .editor-wrapper {
        flex: 1;
        height: 100%;
        min-width: 0;
    }
    .CodeMirror {
        height: 100%;
        font-size: 14px;
        line-height: 1.5;
    }
    .CodeMirror-wrap .CodeMirror-line {
        white-space: pre-wrap !important;
        word-break: break-all;
        overflow-wrap: break-word;
    }
    .cm-s-bespin.CodeMirror {
        background-color: #0a0a0a;
        color: #00c6e0;
    }
    .cm-s-bespin .CodeMirror-gutters {
        background: #121212;
        border-right: 1px solid #333;
    }
    .cm-s-bespin .CodeMirror-linenumber { color: #666; }

    .line-ws-removed { background-color: rgba(255, 193, 7, 0.25); }
    .line-ws-added { background-color: rgba(0, 123, 255, 0.2); }

    .line-added { background-color: rgba(40, 167, 69, 0.2); }
    .line-removed { background-color: rgba(220, 53, 69, 0.25); }
    .line-placeholder { background-color: #1a1a1a; }

    .char-added {
        background-color: rgba(40, 167, 69, 0.5);
        border-radius: 2px;
    }
    .char-removed {
        background-color: rgba(220, 53, 69, 0.5);
        text-decoration: line-through;
        border-radius: 2px;
    }
    .char-removed-ws {
        background-color: rgba(220, 53, 69, 0.5);
        border-radius: 2px;
    }

    #diff-scrollbar {
        width: 5px;
        height: 100%;
        background-color: #2a2a2a;
        position: relative;
        overflow: hidden;
    }
    .diff-marker {
        position: absolute;
        width: 100%;
        height: 3px;
        left: 0;
    }
    .marker-added { background-color: #28a745; }
    .marker-removed { background-color: #dc3545; }
</style>
</head>
<body>

<div class="container">
    <!-- === ИЗМЕНЕНИЕ: Упрощенная структура HTML === -->
    <div class="buttons">
        <div class="buttons-left">
            <button id="paste-left">Paste L</button>
            <button id="paste-right">Paste R</button>
            <button id="copy">Copy R</button>
            <button id="copy-l2r-diff">Copy L2R Diff</button>
            <button id="diff">Paste Diff</button>
            <button id="find-diff">Find Diff</button>
            <button id="del-com">DelCom</button>
        </div>

        <div id="diff-nav-buttons">
            <button id="prev-diff" title="Previous Difference">↑</button>
            <button id="next-diff" title="Next Difference">↓</button>
        </div>

        <div class="buttons-right">
            <span id="diff-stats"></span>
        </div>
    </div>
    <!-- === КОНЕЦ ИЗМЕНЕНИЯ === -->
    <div class="editors">
        <div id="left-editor-container" class="editor-wrapper"></div>
        <div id="diff-scrollbar"></div>
        <div id="right-editor-container" class="editor-wrapper"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script>
    const leftEditor = CodeMirror(document.getElementById('left-editor-container'), {
        theme: 'bespin',
        lineNumbers: true,
        lineWrapping: true,
    });

    const rightEditor = CodeMirror(document.getElementById('right-editor-container'), {
        theme: 'bespin',
        lineNumbers: true,
        lineWrapping: true,
    });

    const diffScrollbar = document.getElementById('diff-scrollbar');
    const diffStats = document.getElementById('diff-stats');

    const diffNavButtons = document.getElementById('diff-nav-buttons');
    const prevDiffButton = document.getElementById('prev-diff');
    const nextDiffButton = document.getElementById('next-diff');

    let preDiffLeftText = null;
    let preDiffRightText = null;
    let isApplyingDiff = false;
    let leftViewToOrigLineMap = [];
    let rightViewToOrigLineMap = [];

    let diffLinesArray = [];
    let currentDiffIndex = -1;

    let isSyncing = false;
    leftEditor.on("scroll", (cm) => { if (!isSyncing) { isSyncing = true; rightEditor.scrollTo(cm.getScrollInfo().left, cm.getScrollInfo().top); isSyncing = false; } });
    rightEditor.on("scroll", (cm) => { if (!isSyncing) { isSyncing = true; leftEditor.scrollTo(cm.getScrollInfo().left, cm.getScrollInfo().top); isSyncing = false; } });

    function clearAllDiffHighlighting(editor) {
        editor.getAllMarks().forEach(marker => marker.clear());

        for (let i = 0; i < editor.lineCount(); i++) {
            editor.removeLineClass(i, 'background', 'line-added');
            editor.removeLineClass(i, 'background', 'line-removed');
            editor.removeLineClass(i, 'background', 'line-placeholder');
            editor.removeLineClass(i, 'background', 'line-ws-added');
            editor.removeLineClass(i, 'background', 'line-ws-removed');
        }
    }

    function beforeChangeHandler(cm, change) {
        if (isApplyingDiff || preDiffLeftText === null || change.origin === 'setValue') {
            return;
        }

        change.cancel();
        isApplyingDiff = true;

        const targetEditor = (cm === leftEditor) ? leftEditor : rightEditor;
        const map = (cm === leftEditor) ? leftViewToOrigLineMap : rightViewToOrigLineMap;

        function mapLine(viewLine) {
            let origLine = map[viewLine];
            if (origLine !== null && origLine !== undefined) return origLine;
            for (let i = viewLine - 1; i >= 0; i--) {
                if (map[i] !== null && map[i] !== undefined) return map[i] + 1;
            }
            return 0;
        }

        const origFromLine = mapLine(change.from.line);
        const origToLine = mapLine(change.to.line);
        const origFrom = { line: origFromLine, ch: change.from.ch };
        const origTo = { line: origToLine, ch: change.to.ch };

        const newCursorLine = origFrom.line + change.text.length - 1;
        const lastLineText = change.text[change.text.length - 1];
        const newCursorCh = (change.text.length === 1) ? origFrom.ch + lastLineText.length : lastLineText.length;
        const newCursorPos = { line: newCursorLine, ch: newCursorCh };

        leftEditor.setValue(preDiffLeftText);
        rightEditor.setValue(preDiffRightText);

        clearAllDiffHighlighting(leftEditor);
        clearAllDiffHighlighting(rightEditor);

        preDiffLeftText = null;
        preDiffRightText = null;
        diffScrollbar.innerHTML = '';
        diffStats.textContent = '';

        diffNavButtons.style.display = 'none';
        diffLinesArray = [];
        currentDiffIndex = -1;

        targetEditor.replaceRange(change.text, origFrom, origTo);
        targetEditor.setCursor(newCursorPos);
        targetEditor.focus();

        isApplyingDiff = false;
    }

    leftEditor.on("beforeChange", beforeChangeHandler);
    rightEditor.on("beforeChange", beforeChangeHandler);

    document.getElementById('paste-left').addEventListener('click', () => navigator.clipboard.readText().then(text => leftEditor.setValue(text)).catch(err => console.error(err)));
    document.getElementById('paste-right').addEventListener('click', () => navigator.clipboard.readText().then(text => rightEditor.setValue(text)).catch(err => console.error(err)));

    document.getElementById('find-diff').addEventListener('click', () => {
        if (preDiffLeftText !== null) {
            leftEditor.setValue(preDiffLeftText);
            rightEditor.setValue(preDiffRightText);
        }
        const leftText = leftEditor.getValue();
        const rightText = rightEditor.getValue();

        preDiffLeftText = leftText;
        preDiffRightText = rightText;

        const changes = Diff.diffLines(leftText, rightText);
        updateDiffStats(changes);
        renderDiffView(changes);
    });

    document.getElementById('diff').addEventListener('click', () => {
        navigator.clipboard.readText()
            .then(patch_text => {
                if (preDiffLeftText !== null) leftEditor.setValue(preDiffLeftText);

                const original_text = leftEditor.getValue();
                const patched = Diff.applyPatch(original_text, patch_text);

                if (patched === false) {
                    preDiffLeftText = null; preDiffRightText = null;
                    rightEditor.setValue("Error: Patch could not be applied.");
                    leftEditor.setValue(original_text);
                    return;
                }

                preDiffLeftText = original_text;
                preDiffRightText = patched;

                const changes = Diff.diffLines(original_text, patched);
                updateDiffStats(changes);
                renderDiffView(changes);
            })
            .catch(err => {
                rightEditor.setValue(`Error applying patch:\n${err.message}`);
                console.error(err);
            });
    });

    document.getElementById('copy').addEventListener('click', () => navigator.clipboard.writeText(preDiffRightText || rightEditor.getValue()).catch(err => console.error(err)));

    document.getElementById('copy-l2r-diff').addEventListener('click', () => {
        const leftText = preDiffLeftText || leftEditor.getValue();
        const rightText = preDiffRightText || rightEditor.getValue();
        const correctPatch = Diff.createPatch('file.txt', leftText, rightText, 'a/left.txt', 'b/right.txt');

        navigator.clipboard.writeText(correctPatch)
            .then(() => {
                const button = document.getElementById('copy-l2r-diff');
                const originalButtonText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalButtonText; }, 1500);
            })
            .catch(err => console.error(err));
    });

    function removeComments(code) {
        let result = '';
        let inMultilineComment = false;
        let inSingleLineComment = false;
        let inRegex = false;
        let inCharClass = false;
        let quoteChar = null;

        for (let i = 0; i < code.length; i++) {
            const char = code[i];
            const prevChar = i > 0 ? code[i - 1] : null;
            const nextChar = i < code.length - 1 ? code[i + 1] : null;

            if (char === '`' && nextChar === '`' && code[i + 2] === '`') {
                result += '```';
                i += 2;
                continue;
            }

            if ((quoteChar || inRegex) && char === '\\' && prevChar !== '\\') {
                result += char + (nextChar || '');
                i++;
                continue;
            }

            if (inMultilineComment) {
                if (char === '*' && nextChar === '/') {
                    inMultilineComment = false;
                    i++;
                }
                continue;
            }

            if (inSingleLineComment) {
                if (char === '\n') {
                    inSingleLineComment = false;
                    result += char;
                }
                continue;
            }

            if (quoteChar) {
                result += char;
                if (char === quoteChar) {
                    quoteChar = null;
                }
                continue;
            }

            if (inRegex) {
                result += char;
                if (inCharClass) {
                    if (char === ']') {
                        inCharClass = false;
                    }
                } else {
                    if (char === '[') {
                        inCharClass = true;
                    } else if (char === '/') {
                        inRegex = false;
                    }
                }
                continue;
            }

            if (char === '/' && nextChar === '*') {
                inMultilineComment = true;
                i++;
                continue;
            }
            if (char === '/' && nextChar === '/') {
                inSingleLineComment = true;
                i++;
                continue;
            }

            if (char === "'" || char === '"' || char === '`') {
                quoteChar = char;
                result += char;
                continue;
            }

            if (char === '/') {
                let j = result.length - 1;
                while (j >= 0 && /\s/.test(result[j])) {
                    j--;
                }
                const lastMeaningfulChar = j >= 0 ? result[j] : '';

                if ('([,=:[!&|?{};'.includes(lastMeaningfulChar) || lastMeaningfulChar === '') {
                    inRegex = true;
                    result += char;
                    continue;
                }
            }
            result += char;
        }
        return result.replace(/[ \t]+$/gm, '');
    }

    document.getElementById('del-com').addEventListener('click', () => {
        const originalLeftText = leftEditor.getValue();
        rightEditor.setValue(originalLeftText);
        const cleanedLeftText = removeComments(originalLeftText);
        leftEditor.setValue(cleanedLeftText);
    });

    function updateDiffStats(changes) {
        let addedCount = 0;
        let removedCount = 0;
        changes.forEach(part => {
            if (part.added) {
                addedCount += part.count;
            } else if (part.removed) {
                removedCount += part.count;
            }
        });
        diffStats.textContent = `+ ${addedCount} | - ${removedCount}`;
    }

    function renderDiffView(changes) {
        clearAllDiffHighlighting(leftEditor);
        clearAllDiffHighlighting(rightEditor);

        diffScrollbar.innerHTML = '';
        leftViewToOrigLineMap = [];
        rightViewToOrigLineMap = [];

        diffLinesArray = [];
        currentDiffIndex = -1;

        let origLeftLineCounter = 0;
        let origRightLineCounter = 0;
        let viewLineCounter = 0;

        const leftLines = [];
        const rightLines = [];
        const lineClasses = [];
        const charMarks = [];

        for (let i = 0; i < changes.length; i++) {
            const part = changes[i];
            const nextPart = (i + 1 < changes.length) ? changes[i + 1] : null;

            if (part.added || part.removed) {
                diffLinesArray.push(viewLineCounter);
            }

            if (part.removed && nextPart && nextPart.added) {
                const removedLines = part.value.replace(/\n$/, "").split("\n");
                const addedLines = nextPart.value.replace(/\n$/, "").split("\n");
                const maxLen = Math.max(removedLines.length, addedLines.length);

                for (let j = 0; j < maxLen; j++) {
                    const leftLine = removedLines[j] || '';
                    const rightLine = addedLines[j] || '';
                    leftLines.push(leftLine);
                    rightLines.push(rightLine);

                    const isWhitespaceOnlyChange = leftLine.replace(/\s+/g, '') === rightLine.replace(/\s+/g, '');

                    if (isWhitespaceOnlyChange) {
                        lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-ws-removed' });
                        lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-ws-added' });
                    } else {
                        lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-removed' });
                        lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-added' });
                    }
                    createMarker('marker-removed', viewLineCounter);

                    const charDiff = Diff.diffChars(leftLine, rightLine);
                    let leftCh = 0;
                    let rightCh = 0;

                    charDiff.forEach(charPart => {
                        if (charPart.added) {
                            charMarks.push({
                                editor: 'right', line: viewLineCounter,
                                from: rightCh, to: rightCh + charPart.value.length,
                                className: 'char-added'
                            });
                            rightCh += charPart.value.length;
                        } else if (charPart.removed) {
                            const className = (charPart.value.trim() === '') ? 'char-removed-ws' : 'char-removed';
                            charMarks.push({
                                editor: 'left', line: viewLineCounter,
                                from: leftCh, to: leftCh + charPart.value.length,
                                className: className
                            });
                            leftCh += charPart.value.length;
                        } else {
                            leftCh += charPart.value.length;
                            rightCh += charPart.value.length;
                        }
                    });

                    if (j < removedLines.length) leftViewToOrigLineMap[viewLineCounter] = origLeftLineCounter++;
                    else leftViewToOrigLineMap[viewLineCounter] = null;
                    if (j < addedLines.length) rightViewToOrigLineMap[viewLineCounter] = origRightLineCounter++;
                    else rightViewToOrigLineMap[viewLineCounter] = null;

                    viewLineCounter++;
                }
                i++;
            } else if (part.added) {
                createMarker('marker-added', viewLineCounter);
                let lines = part.value.replace(/\n$/, "").split("\n");
                for (const line of lines) {
                    leftLines.push('');
                    rightLines.push(line);
                    lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-added' });
                    lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-placeholder' });
                    leftViewToOrigLineMap[viewLineCounter] = null;
                    rightViewToOrigLineMap[viewLineCounter] = origRightLineCounter++;
                    viewLineCounter++;
                }
            } else if (part.removed) {
                createMarker('marker-removed', viewLineCounter);
                let lines = part.value.replace(/\n$/, "").split("\n");
                for (const line of lines) {
                    leftLines.push(line);
                    rightLines.push('');
                    lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-removed' });
                    lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-placeholder' });
                    leftViewToOrigLineMap[viewLineCounter] = origLeftLineCounter++;
                    rightViewToOrigLineMap[viewLineCounter] = null;
                    viewLineCounter++;
                }
            } else {
                let lines = part.value.replace(/\n$/, "").split("\n");
                for (const line of lines) {
                    leftLines.push(line);
                    rightLines.push(line);
                    leftViewToOrigLineMap[viewLineCounter] = origLeftLineCounter++;
                    rightViewToOrigLineMap[viewLineCounter] = origRightLineCounter++;
                    viewLineCounter++;
                }
            }
        }

        isApplyingDiff = true;
        leftEditor.setValue(leftLines.join('\n'));
        rightEditor.setValue(rightLines.join('\n'));
        isApplyingDiff = false;

        lineClasses.forEach(lc => {
            const editor = (lc.editor === 'left') ? leftEditor : rightEditor;
            editor.addLineClass(lc.line, 'background', lc.class);
        });

        charMarks.forEach(m => {
            const editor = (m.editor === 'left') ? leftEditor : rightEditor;
            editor.markText(
                { line: m.line, ch: m.from },
                { line: m.line, ch: m.to },
                { className: m.className }
            );
        });

        const totalLines = leftLines.length;
        const markers = diffScrollbar.querySelectorAll('.diff-marker');
        markers.forEach(marker => {
            const lineNumber = parseInt(marker.dataset.line, 10);
            if (totalLines > 0) marker.style.top = `${(lineNumber / totalLines) * 100}%`;
        });

        if (diffLinesArray.length > 0) {

            diffNavButtons.style.display = 'block';
        } else {
            diffNavButtons.style.display = 'none';
        }
    }

    function createMarker(type, lineNumber) {
        const marker = document.createElement('div');
        marker.className = `diff-marker ${type}`;
        marker.dataset.line = lineNumber;
        marker.style.top = '0%';
        diffScrollbar.appendChild(marker);
    }

    function navigateToDiff(direction) {
        if (diffLinesArray.length === 0) return;

        currentDiffIndex += direction;

        if (currentDiffIndex >= diffLinesArray.length) {
            currentDiffIndex = 0;
        }
        if (currentDiffIndex < 0) {
            currentDiffIndex = diffLinesArray.length - 1;
        }

        const targetLine = diffLinesArray[currentDiffIndex];


        const editorHeight = leftEditor.getScrollInfo().clientHeight;
        const linePos = leftEditor.charCoords({line: targetLine, ch: 0}, "local").top;

        leftEditor.scrollTo(null, linePos - (editorHeight / 2));

        leftEditor.setCursor(targetLine, 0);
        leftEditor.focus();
    }

    nextDiffButton.addEventListener('click', () => navigateToDiff(1));
    prevDiffButton.addEventListener('click', () => navigateToDiff(-1));

</script>

</body>
</html>
