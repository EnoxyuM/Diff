<html>
<head>
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="64x64" href="icons/favicon-64x64.png">
    <title>Diff</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/bespin.min.css">

<style>

    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #0a0a0a;
        color: #00c6e0;
        font-family: monospace;
        overflow: hidden;
    }
    .container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .editors {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
    }
    .editor-wrapper {
        flex: 1;
        height: 100%;
        min-width: 0;
        width: 50%;
    }
    .CodeMirror {
        height: 100%;
        font-size: 14px;
        line-height: 1.5;
    }
    .CodeMirror-wrap .CodeMirror-line {
        white-space: pre-wrap !important;
        word-break: break-all;
        overflow-wrap: break-word;
    }
    .cm-s-bespin.CodeMirror {
        background-color: #0a0a0a;
        color: #00c6e0;
    }
    .cm-s-bespin .CodeMirror-gutters {
        background: #121212;
        border-right: 1px solid #333;
    }
    .cm-s-bespin .CodeMirror-linenumber { color: #666; }


    .line-ws-removed { background-color: rgba(255, 193, 7, 0.25); }
    .line-ws-added { background-color: rgba(0, 123, 255, 0.2); }
    .line-added { background-color: rgba(40, 167, 69, 0.2); }
    .line-removed { background-color: rgba(220, 53, 69, 0.25); }
    .line-placeholder { background-color: #1a1a1a; }
    .char-added { background-color: rgba(40, 167, 69, 0.5); border-radius: 2px; }
    .char-removed { background-color: rgba(220, 53, 69, 0.5); text-decoration: line-through; border-radius: 2px; }
    .char-removed-ws { background-color: rgba(220, 53, 69, 0.5); border-radius: 2px; }


    #diff-scrollbar { width: 5px; height: 100%; background-color: #2a2a2a; position: relative; overflow: hidden; }
    .diff-marker { position: absolute; width: 100%; height: 3px; left: 0; }
    .marker-added { background-color: #28a745; }
    .marker-removed { background-color: #dc3545; }


    #copy-feedback-popup {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #00c6e0;
        color: #0a0a0a;
        padding: 8px 16px;
        border-radius: 5px;
        z-index: 9999;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
        display: none;
    }




    #header-container {
        display: flex;
        align-items: flex-end;
        background: #1a1a1a;
        padding: 1px 10px 0 10px;
        box-sizing: border-box;
        height: 37px;
        position: relative;
        flex-shrink: 0;
        width: 100%;
        border-bottom: 1px solid #00c6e0;
    }


    #diff-buttons-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 0;
    }
    .buttons-left, .buttons-right {
        display: flex;
        align-items: center;
    }


    .header-btn {
        background-color: #2d2d2d;
        color: #ccc;
        border: 1px solid #3c3c3c;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 6px;
        user-select: none;
        font-size: 16px;
        margin-right: 8px;
        height: 35px;
        padding: 0 12px;
        transition: background-color 0.2s, color 0.2s;
        flex-shrink: 0;
    }
    .header-btn:hover {
        background-color: #4a4a4a;
        color: #fff;
    }

    #diff-stats {
        font-size: 14px;
        white-space: nowrap;
        color: #ccc;
        margin-left: 10px;
    }


    #diff-nav-buttons {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: none;
    }
    #diff-nav-buttons button {
        background-color: #2d2d2d;
        color: #ccc;
        border: 1px solid #3c3c3c;
        border-radius: 6px;
        padding: 5px 10px;
        font-size: 16px;
        line-height: 1;
        margin: 0 5px;
        cursor: pointer;
    }
     #diff-nav-buttons button:hover {
        background-color: #4a4a4a;
        color: #fff;
    }


    #tabs-ui-container {
        display: flex;
        align-items: flex-end;
        width: 100%;
        height: 100%;
    }


    #tabs-container {
        display: flex;
        flex: 1;
        min-width: 0;
        height: 100%;
        align-items: flex-end;
    }


    #tabs-wrapper {
        display: flex;
        align-items: flex-end;
        min-width: 0;
        overflow: hidden;
        flex-shrink: 1;
    }


    .tab {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #2d2d2d;
        color: #ccc;
        cursor: pointer;
        border-radius: 8px;
        margin-right: 2px;
        overflow: hidden;
        flex-shrink: 0;
        width: 200px;
        min-width: 1px;
        height: 35px;
        box-sizing: border-box;
        position: relative;
        font-size: 14px;
        white-space: nowrap;
        transition: all 0.2s ease;
        user-select: none;
    }


    .tab span {
        padding: 8px 15px;
        white-space: nowrap;
        overflow: hidden;
        -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        mask-image: linear-gradient(to right, black 85%, transparent 100%);
    }

    .tab:not(.active):hover {
        background: #4a4a4a;
    }


    .tab.active {
        background: #0a0a0a;
        color: #00c6e0;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
        height: 35px;
    }


    #tabs-container.tabs-overflow #tabs-wrapper {
        flex: 1 1 auto;
    }
    #tabs-container.tabs-overflow .tab {
        flex: 1 1 200px;
        width: auto;
    }
</style>
</head>
<body>

<div id="copy-feedback-popup">Copied!</div>

<div class="container">
    <div id="header-container">

        <div id="diff-buttons-container">
            <div class="buttons-left">
                <button id="to-tabs" class="header-btn" title="Parse clipboard to tabs">ðŸ“œ</button>
                <button id="paste-left" class="header-btn">Paste L</button>
                <button id="paste-right" class="header-btn">Paste R</button>
                <button id="copy" class="header-btn">Copy R</button>
                <button id="copy-l2r-diff" class="header-btn">Copy L2R Diff</button>
                <button id="diff" class="header-btn">Paste Diff</button>
                <button id="find-diff" class="header-btn">Find Diff</button>
                <button id="del-com" class="header-btn">DelCom</button>
            </div>

            <div id="diff-nav-buttons">
                <button id="prev-diff" title="Previous Difference">â†‘</button>
                <button id="next-diff" title="Next Difference">â†“</button>
            </div>

            <div class="buttons-right">
                <span id="diff-stats"></span>
            </div>
        </div>


    </div>
    <div class="editors">
        <div id="left-editor-container" class="editor-wrapper"></div>
        <div id="diff-scrollbar"></div>
        <div id="right-editor-container" class="editor-wrapper"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    const leftEditor = CodeMirror(document.getElementById('left-editor-container'), {
        theme: 'bespin',
        lineNumbers: true,
        lineWrapping: true,
    });

    const rightEditor = CodeMirror(document.getElementById('right-editor-container'), {
        theme: 'bespin',
        lineNumbers: true,
        lineWrapping: true,
    });


    const headerContainer = document.getElementById('header-container');
    const diffButtonsContainer = document.getElementById('diff-buttons-container');
    const diffScrollbar = document.getElementById('diff-scrollbar');
    const diffStats = document.getElementById('diff-stats');
    const diffNavButtons = document.getElementById('diff-nav-buttons');
    const prevDiffButton = document.getElementById('prev-diff');
    const nextDiffButton = document.getElementById('next-diff');
    const rightEditorContainer = document.getElementById('right-editor-container');
    const diffScrollbarEl = document.getElementById('diff-scrollbar');

    let preDiffLeftText = null;
    let preDiffRightText = null;
    let isApplyingDiff = false;
    let leftViewToOrigLineMap = [];
    let rightViewToOrigLineMap = [];

    let diffLinesArray = [];
    let currentDiffIndex = -1;

    let isSyncing = false;
    leftEditor.on("scroll", (cm) => { if (!isSyncing) { isSyncing = true; rightEditor.scrollTo(cm.getScrollInfo().left, cm.getScrollInfo().top); isSyncing = false; } });
    rightEditor.on("scroll", (cm) => { if (!isSyncing) { isSyncing = true; leftEditor.scrollTo(cm.getScrollInfo().left, cm.getScrollInfo().top); isSyncing = false; } });


    let feedbackTimeout;
    function showCopyFeedback() {
        const popup = document.getElementById('copy-feedback-popup');
        clearTimeout(feedbackTimeout);

        popup.style.display = 'block';
        setTimeout(() => { popup.style.opacity = 1; }, 10);

        feedbackTimeout = setTimeout(() => {
            popup.style.opacity = 0;
            setTimeout(() => { popup.style.display = 'none'; }, 300);
        }, 1000);
    }


    function clearAllDiffHighlighting(editor) {
        editor.getAllMarks().forEach(marker => marker.clear());
        for (let i = 0; i < editor.lineCount(); i++) {
            editor.removeLineClass(i, 'background');
        }
    }

    function beforeChangeHandler(cm, change) {
        if (isApplyingDiff || preDiffLeftText === null || change.origin === 'setValue') return;
        change.cancel();
        isApplyingDiff = true;

        const targetEditor = (cm === leftEditor) ? leftEditor : rightEditor;
        const map = (cm === leftEditor) ? leftViewToOrigLineMap : rightViewToOrigLineMap;

        function mapLine(viewLine) {
            let origLine = map[viewLine];
            if (origLine !== null && origLine !== undefined) return origLine;
            for (let i = viewLine - 1; i >= 0; i--) {
                if (map[i] !== null && map[i] !== undefined) return map[i] + 1;
            }
            return 0;
        }

        const origFromLine = mapLine(change.from.line);
        const origToLine = mapLine(change.to.line);
        const origFrom = { line: origFromLine, ch: change.from.ch };
        const origTo = { line: origToLine, ch: change.to.ch };

        const newCursorLine = origFrom.line + change.text.length - 1;
        const lastLineText = change.text[change.text.length - 1];
        const newCursorCh = (change.text.length === 1) ? origFrom.ch + lastLineText.length : lastLineText.length;
        const newCursorPos = { line: newCursorLine, ch: newCursorCh };

        leftEditor.setValue(preDiffLeftText);
        rightEditor.setValue(preDiffRightText);
        clearAllDiffHighlighting(leftEditor);
        clearAllDiffHighlighting(rightEditor);

        preDiffLeftText = null;
        preDiffRightText = null;
        diffScrollbar.innerHTML = '';
        diffStats.textContent = '';
        diffNavButtons.style.display = 'none';
        diffLinesArray = [];
        currentDiffIndex = -1;

        targetEditor.replaceRange(change.text, origFrom, origTo);
        targetEditor.setCursor(newCursorPos);
        targetEditor.focus();
        isApplyingDiff = false;
    }

    leftEditor.on("beforeChange", beforeChangeHandler);
    rightEditor.on("beforeChange", beforeChangeHandler);

    document.getElementById('paste-left').addEventListener('click', () => navigator.clipboard.readText().then(text => leftEditor.setValue(text)).catch(err => console.error(err)));
    document.getElementById('paste-right').addEventListener('click', () => navigator.clipboard.readText().then(text => rightEditor.setValue(text)).catch(err => console.error(err)));
    document.getElementById('copy').addEventListener('click', () => { navigator.clipboard.writeText(preDiffRightText || rightEditor.getValue()).then(showCopyFeedback).catch(err => console.error(err)); });

    document.getElementById('find-diff').addEventListener('click', () => {
        if (preDiffLeftText !== null) {
            leftEditor.setValue(preDiffLeftText);
            rightEditor.setValue(preDiffRightText);
        }
        const leftText = leftEditor.getValue();
        const rightText = rightEditor.getValue();
        preDiffLeftText = leftText;
        preDiffRightText = rightText;
        const changes = Diff.diffLines(leftText, rightText);
        updateDiffStats(changes);
        renderDiffView(changes);
    });

    document.getElementById('diff').addEventListener('click', () => {
        navigator.clipboard.readText().then(patch_text => {
            if (preDiffLeftText !== null) leftEditor.setValue(preDiffLeftText);
            const original_text = leftEditor.getValue();
            const patched = Diff.applyPatch(original_text, patch_text);
            if (patched === false) {
                preDiffLeftText = null; preDiffRightText = null;
                rightEditor.setValue("Error: Patch could not be applied.");
                leftEditor.setValue(original_text);
                return;
            }
            preDiffLeftText = original_text;
            preDiffRightText = patched;
            const changes = Diff.diffLines(original_text, patched);
            updateDiffStats(changes);
            renderDiffView(changes);
        }).catch(err => {
            rightEditor.setValue(`Error applying patch:\n${err.message}`);
            console.error(err);
        });
    });

    document.getElementById('copy-l2r-diff').addEventListener('click', () => {
        const leftText = preDiffLeftText || leftEditor.getValue();
        const rightText = preDiffRightText || rightEditor.getValue();
        const correctPatch = Diff.createPatch('file.txt', leftText, rightText, 'a/left.txt', 'b/right.txt');
        navigator.clipboard.writeText(correctPatch).then(showCopyFeedback).catch(err => console.error(err));
    });

    function renderDiffView(changes) {
        clearAllDiffHighlighting(leftEditor);
        clearAllDiffHighlighting(rightEditor);

        diffScrollbar.innerHTML = '';
        leftViewToOrigLineMap = []; rightViewToOrigLineMap = [];
        diffLinesArray = []; currentDiffIndex = -1;
        let origLeftLineCounter = 0, origRightLineCounter = 0, viewLineCounter = 0;

        const leftLines = [], rightLines = [], lineClasses = [], charMarks = [];

        for (let i = 0; i < changes.length; i++) {
            const part = changes[i];
            const nextPart = (i + 1 < changes.length) ? changes[i + 1] : null;

            if (part.added || part.removed) { diffLinesArray.push(viewLineCounter); }

            if (part.removed && nextPart && nextPart.added) {
                const removedLines = part.value.replace(/\n$/, "").split("\n");
                const addedLines = nextPart.value.replace(/\n$/, "").split("\n");
                const maxLen = Math.max(removedLines.length, addedLines.length);

                for (let j = 0; j < maxLen; j++) {
                    const leftLine = removedLines[j] || '', rightLine = addedLines[j] || '';
                    leftLines.push(leftLine); rightLines.push(rightLine);
                    const isWhitespaceOnlyChange = leftLine.replace(/\s+/g, '') === rightLine.replace(/\s+/g, '');

                    if (isWhitespaceOnlyChange) {
                        lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-ws-removed' });
                        lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-ws-added' });
                    } else {
                        lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-removed' });
                        lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-added' });
                    }
                    createMarker('marker-removed', viewLineCounter);

                    const charDiff = Diff.diffChars(leftLine, rightLine);
                    let leftCh = 0, rightCh = 0;
                    charDiff.forEach(charPart => {
                        if (charPart.added) {
                            charMarks.push({ editor: 'right', line: viewLineCounter, from: rightCh, to: rightCh + charPart.value.length, className: 'char-added' });
                            rightCh += charPart.value.length;
                        } else if (charPart.removed) {
                            charMarks.push({ editor: 'left', line: viewLineCounter, from: leftCh, to: leftCh + charPart.value.length, className: (charPart.value.trim() === '') ? 'char-removed-ws' : 'char-removed' });
                            leftCh += charPart.value.length;
                        } else {
                            leftCh += charPart.value.length;
                            rightCh += charPart.value.length;
                        }
                    });

                    if (j < removedLines.length) leftViewToOrigLineMap[viewLineCounter] = origLeftLineCounter++; else leftViewToOrigLineMap[viewLineCounter] = null;
                    if (j < addedLines.length) rightViewToOrigLineMap[viewLineCounter] = origRightLineCounter++; else rightViewToOrigLineMap[viewLineCounter] = null;
                    viewLineCounter++;
                }
                i++;
            } else if (part.added) {
                createMarker('marker-added', viewLineCounter);
                part.value.replace(/\n$/, "").split("\n").forEach(line => {
                    leftLines.push(''); rightLines.push(line);
                    lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-added' });
                    lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-placeholder' });
                    leftViewToOrigLineMap[viewLineCounter] = null;
                    rightViewToOrigLineMap[viewLineCounter] = origRightLineCounter++;
                    viewLineCounter++;
                });
            } else if (part.removed) {
                createMarker('marker-removed', viewLineCounter);
                part.value.replace(/\n$/, "").split("\n").forEach(line => {
                    leftLines.push(line); rightLines.push('');
                    lineClasses.push({ editor: 'left', line: viewLineCounter, class: 'line-removed' });
                    lineClasses.push({ editor: 'right', line: viewLineCounter, class: 'line-placeholder' });
                    leftViewToOrigLineMap[viewLineCounter] = origLeftLineCounter++;
                    rightViewToOrigLineMap[viewLineCounter] = null;
                    viewLineCounter++;
                });
            } else {
                part.value.replace(/\n$/, "").split("\n").forEach(line => {
                    leftLines.push(line); rightLines.push(line);
                    leftViewToOrigLineMap[viewLineCounter] = origLeftLineCounter++;
                    rightViewToOrigLineMap[viewLineCounter] = origRightLineCounter++;
                    viewLineCounter++;
                });
            }
        }

        isApplyingDiff = true;
        leftEditor.setValue(leftLines.join('\n')); rightEditor.setValue(rightLines.join('\n'));
        isApplyingDiff = false;

        lineClasses.forEach(lc => { ((lc.editor === 'left') ? leftEditor : rightEditor).addLineClass(lc.line, 'background', lc.class); });
        charMarks.forEach(m => { ((m.editor === 'left') ? leftEditor : rightEditor).markText({ line: m.line, ch: m.from }, { line: m.line, ch: m.to }, { className: m.className }); });

        const totalLines = leftLines.length;
        diffScrollbar.querySelectorAll('.diff-marker').forEach(marker => {
            if (totalLines > 0) marker.style.top = `${(parseInt(marker.dataset.line, 10) / totalLines) * 100}%`;
        });
        diffNavButtons.style.display = diffLinesArray.length > 0 ? 'flex' : 'none';
    }

    function updateDiffStats(changes) {
        let added = 0, removed = 0;
        changes.forEach(p => { if (p.added) added += p.count; else if (p.removed) removed += p.count; });
        diffStats.textContent = `+${added} | -${removed}`;
    }
    function createMarker(type, lineNumber) {
        const marker = document.createElement('div');
        marker.className = `diff-marker ${type}`;
        marker.dataset.line = lineNumber;
        diffScrollbar.appendChild(marker);
    }
    function navigateToDiff(direction) {
        if (diffLinesArray.length === 0) return;
        currentDiffIndex = (currentDiffIndex + direction + diffLinesArray.length) % diffLinesArray.length;
        const targetLine = diffLinesArray[currentDiffIndex];
        const editorHeight = leftEditor.getScrollInfo().clientHeight;
        const linePos = leftEditor.charCoords({line: targetLine, ch: 0}, "local").top;
        leftEditor.scrollTo(null, linePos - (editorHeight / 2));
        leftEditor.setCursor(targetLine, 0);
        leftEditor.focus();
    }
    nextDiffButton.addEventListener('click', () => navigateToDiff(1));
    prevDiffButton.addEventListener('click', () => navigateToDiff(-1));


    function removeComments(code) {
        let result = '';
        let inMultilineComment = false, inSingleLineComment = false, inHtmlComment = false,
            inRegex = false, inCharClass = false;
        let quoteChar = null;

        for (let i = 0; i < code.length; i++) {
            const char = code[i], prevChar = i > 0 ? code[i-1] : null;
            const nextChar = i < code.length - 1 ? code[i+1] : null;
            const nextNextChar = i < code.length - 2 ? code[i+2] : null;
            const nextNextNextChar = i < code.length - 3 ? code[i+3] : null;

            if (char === '`' && nextChar === '`' && nextNextChar === '`') {
                if (!inMultilineComment && !inSingleLineComment && !inHtmlComment && !inRegex && !quoteChar) {
                    result += '```';
                    i += 2;
                    continue;
                }
            }

            if ((quoteChar || inRegex) && char === '\\' && prevChar !== '\\') {
                result += char + (nextChar || '');
                i++;
                continue;
            }

            if (inHtmlComment) {
                if (char === '-' && nextChar === '-' && nextNextChar === '>') {
                    inHtmlComment = false;
                    i += 2;
                }
                continue;
            }
            if (inMultilineComment) {
                if (char === '*' && nextChar === '/') {
                    inMultilineComment = false;
                    i++;
                }
                continue;
            }
            if (inSingleLineComment) {
                if (char === '\n') {
                    inSingleLineComment = false;
                    result += char;
                }
                continue;
            }

            if (quoteChar) {
                result += char;
                if (char === quoteChar) quoteChar = null;
                continue;
            }
            if (inRegex) {
                result += char;
                if (inCharClass) {
                    if (char === ']') inCharClass = false;
                } else {
                    if (char === '[') inCharClass = true;
                    else if (char === '/') inRegex = false;
                }
                continue;
            }

            if (char === '<' && nextChar === '!' && nextNextChar === '-' && nextNextNextChar === '-') {
                inHtmlComment = true;
                i += 3;
                continue;
            }
            if (char === '/' && nextChar === '*') {
                inMultilineComment = true;
                i++;
                continue;
            }
            if (char === '/' && nextChar === '/') {
                inSingleLineComment = true;
                i++;
                continue;
            }
            if (char === "'" || char === '"' || char === '`') {
                quoteChar = char;
                result += char;
                continue;
            }
            if (char === '/') {
                let j = result.length - 1;
                while (j >= 0 && /\s/.test(result[j])) j--;
                const lastMeaningfulChar = j >= 0 ? result[j] : '';
                if ('([,=:[!&|?{};'.includes(lastMeaningfulChar) || lastMeaningfulChar === '') {
                    inRegex = true;
                    result += char;
                    continue;
                }
            }
            result += char;
        }
        return result.replace(/[ \t]+$/gm, '');
    }

    document.getElementById('del-com').addEventListener('click', () => {
        const originalLeftText = leftEditor.getValue();
        rightEditor.setValue(originalLeftText);
        leftEditor.setValue(removeComments(originalLeftText));
    });




    function checkTabsOverflow() {
        const tabsContainer = document.getElementById('tabs-container');
        const tabsWrapper = document.getElementById('tabs-wrapper');
        if (!tabsContainer || !tabsWrapper) return;

        if (tabsWrapper.scrollWidth > tabsWrapper.clientWidth + 2) {
            tabsContainer.classList.add('tabs-overflow');
        } else {
            tabsContainer.classList.remove('tabs-overflow');
        }
    }


    function parseTabsFromClipboard(text) {
        const tabs = [];
        let searchFrom = 0;
        const findNextBlockDelimiter = (txt, start = 0) => {
            let inSingle = false, inDouble = false;
            for (let i = start; i < txt.length - 2; i++) {
                const char = txt[i], prev = i > 0 ? txt[i - 1] : null;
                if (char === "'" && prev !== '\\') inSingle = !inSingle;
                else if (char === '"' && prev !== '\\') inDouble = !inDouble;
                if (!inSingle && !inDouble && char === '`' && txt[i + 1] === '`' && txt[i + 2] === '`') return i;
            }
            return -1;
        };
        const findTabName = header => {
            const lines = header.split('\n');
            for (let i = lines.length - 1; i >= 0; i--) {
                const trimmed = lines[i].trim();
                if (trimmed && trimmed.replace(/#|\s/g, '').length > 0) return trimmed.replace(/^#+\s*/, '').trim();
            }
            return null;
        };
        while (true) {
            const blockStart = findNextBlockDelimiter(text, searchFrom);
            if (blockStart === -1) break;
            const tabName = findTabName(text.substring(searchFrom, blockStart));
            if (tabName === null) { if (tabs.length === 0) { searchFrom = blockStart + 3; continue; } else break; }
            let contentStart = blockStart + 3;
            const lineBreakAfter = text.indexOf('\n', contentStart);
            if (lineBreakAfter !== -1 && text.substring(contentStart, lineBreakAfter).trim().length < 20) {
                contentStart = lineBreakAfter + 1;
            }
            const blockEnd = findNextBlockDelimiter(text, contentStart);
            if (blockEnd === -1) break;
            tabs.push({ name: tabName, content: text.substring(contentStart, blockEnd).trim() });
            searchFrom = blockEnd + 3;
        }
        return tabs;
    }


    function enterTabView(tabsData) {
        if (!tabsData || tabsData.length === 0) return;

        diffButtonsContainer.style.display = 'none';
        rightEditorContainer.style.display = 'none';
        diffScrollbarEl.style.display = 'none';


        let tabsUiContainer = document.getElementById('tabs-ui-container');
        if (!tabsUiContainer) {
            tabsUiContainer = document.createElement('div');
            tabsUiContainer.id = 'tabs-ui-container';
            headerContainer.appendChild(tabsUiContainer);
        }
        tabsUiContainer.style.display = 'flex';
        tabsUiContainer.innerHTML = '';


        const backButton = document.createElement('button');
        backButton.innerHTML = '&larr;';
        backButton.className = 'header-btn';
        backButton.title = 'Back to Diff View';
        backButton.addEventListener('click', exitTabView);
        tabsUiContainer.appendChild(backButton);


        const copyAllButton = document.createElement('button');
        copyAllButton.textContent = 'ðŸ“‹';
        copyAllButton.className = 'header-btn';
        copyAllButton.title = 'Copy All Tabs';
        copyAllButton.addEventListener('click', () => {
            const fullText = tabsData.map(tab => `${tab.name}\n\`\`\`\n${tab.content}\n\`\`\``).join('\n\n');
            navigator.clipboard.writeText(fullText).then(showCopyFeedback).catch(err => alert('Failed to copy: ' + err));
        });
        tabsUiContainer.appendChild(copyAllButton);


        const downloadZipButton = document.createElement('button');
        downloadZipButton.textContent = 'ðŸ“š';
        downloadZipButton.className = 'header-btn';
        downloadZipButton.title = 'Download as ZIP Archive';
        downloadZipButton.addEventListener('click', () => {
            const zip = new JSZip();
            tabsData.forEach(tab => zip.file(tab.name, tab.content));
            const now = new Date();
            const filename = `${now.getDate().toString().padStart(2,'0')}.${(now.getMonth()+1).toString().padStart(2,'0')}.${now.getFullYear()} ${now.getHours().toString().padStart(2,'0')};${now.getMinutes().toString().padStart(2,'0')};${now.getSeconds().toString().padStart(2,'0')}.zip`;
            zip.generateAsync({ type: "blob" }).then(content => saveAs(content, filename));
        });
        tabsUiContainer.appendChild(downloadZipButton);


        const tabsContainer = document.createElement('div');
        tabsContainer.id = 'tabs-container';
        const tabsWrapper = document.createElement('div');
        tabsWrapper.id = 'tabs-wrapper';
        tabsContainer.appendChild(tabsWrapper);
        tabsUiContainer.appendChild(tabsContainer);


        tabsData.forEach((tab, index) => {
            const tabDiv = document.createElement('div');
            tabDiv.className = 'tab';
            tabDiv.dataset.content = tab.content;
            tabDiv.title = tab.name;

            const tabSpan = document.createElement('span');
            tabSpan.textContent = tab.name;
            tabDiv.appendChild(tabSpan);

            tabDiv.addEventListener('click', (e) => {
                const clickedTab = e.currentTarget;
                if (clickedTab.classList.contains('active')) {
                    navigator.clipboard.writeText(clickedTab.dataset.content).then(showCopyFeedback).catch(err => console.error(err));
                    return;
                }
                tabsWrapper.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
                clickedTab.classList.add('active');
                isApplyingDiff = true;
                leftEditor.setValue(clickedTab.dataset.content);
                rightEditor.setValue('');
                clearAllDiffHighlighting(leftEditor);
                setTimeout(() => { isApplyingDiff = false; }, 0);
            });
            tabsWrapper.appendChild(tabDiv);
            if (index === 0) tabDiv.click();
        });


        setTimeout(checkTabsOverflow, 50);
    }


    function exitTabView() {
        const tabsUiContainer = document.getElementById('tabs-ui-container');
        if (tabsUiContainer) {
            tabsUiContainer.style.display = 'none';
        }
        diffButtonsContainer.style.display = 'flex';
        rightEditorContainer.style.display = '';
        diffScrollbarEl.style.display = '';

        isApplyingDiff = true;
        leftEditor.setValue(preDiffLeftText || '');
        rightEditor.setValue(preDiffRightText || '');
        isApplyingDiff = false;

        if (preDiffLeftText !== null) {
            document.getElementById('find-diff').click();
        } else {
             clearAllDiffHighlighting(leftEditor);
             clearAllDiffHighlighting(rightEditor);
        }
    }



    document.getElementById('to-tabs').addEventListener('click', () => {
        navigator.clipboard.readText().then(text => {
            const trimmedText = text.trim();
            if (!trimmedText) return;

            let tabsData = parseTabsFromClipboard(trimmedText);


            if (tabsData.length === 0) {
                const lines = trimmedText.split('\n');
                const firstLine = lines[0].trim();
                let content = lines.slice(1).join('\n');


                const firstLineIsHeader = content.trim() !== '' &&
                                          (firstLine.includes('/') || (!firstLine.includes(' ') && firstLine.includes('.')));

                if (firstLineIsHeader) {


                    const trimmedContent = content.trim();
                    if (trimmedContent.startsWith('```') && trimmedContent.endsWith('```')) {

                        const contentLines = trimmedContent.split('\n');
                        content = contentLines.slice(1, contentLines.length - 1).join('\n');
                    }


                    tabsData = [{ name: firstLine, content: content }];
                } else {

                    const defaultName = trimmedText.split('\n')[0].trim().substring(0, 50) || 'Clipboard';
                    tabsData = [{ name: defaultName, content: trimmedText }];
                }
            }

            enterTabView(tabsData);
        }).catch(err => {
            console.error('Failed to read clipboard: ', err);
            alert('Failed to read from clipboard.');
        });
    });



    window.addEventListener('resize', checkTabsOverflow);

</script>

</body>
</html>
